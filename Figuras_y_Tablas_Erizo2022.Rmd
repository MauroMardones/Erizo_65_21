---
title: "DIAGNÓSTICO DE MODELOS DE EVALUACIÓN DE STOCK DE ERIZO"
toc: TRUE
output: 
    pdf_document:
header-includes:
- \usepackage{draftwatermark}
- \SetWatermarkText{}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{parskip}
- \usepackage{caption}
- \captionsetup[table]{name=\textbf{Tabla},labelsep=period}
- \captionsetup[figure]{name=\textbf{Figura},labelsep=period}
- \captionsetup{justification=justified,format=plain,font=small,labelfont=bf,margin=50pt}
- \pagestyle{fancy}
- \usepackage{geometry}
- \geometry{top=1.5cm, bottom=1cm, left=2.5cm, right=2.5cm}
- \usepackage{helvet}
- \renewcommand{\familydefault}{\sfdefault}
- \renewcommand{\baselinestretch}{1.25}
- \newcommand{\sietepuntos}{\fontsize{7pt}{\baselineskip}\selectfont}
- \newcommand{\cincopuntos}{\fontsize{6pt}{\baselineskip}\selectfont}

- \addtolength{\headheight}{4.5\baselineskip}
- \setlength{\headheight}{70pt}
- \setlength{\footskip}{5pt}
- \setlength{\textheight}{658pt}
- \fancyhead[CO,CE]{\includegraphics[height=1.5cm]{Figuras/logoifop.png}\\ \sietepuntos INSTITUTO DE FOMENTO PESQUERO / DIVISION INVESTIGACION PESQUERA}
- \fancyhead[LO,LE]{ }
- \fancyhead[RO,RE]{ }
- \renewcommand{\headrulewidth}{0.5pt}
- \fancyfoot[C]{\cincopuntos \thepage \\ \vspace{-0.2cm} ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \\ }
---
\pagebreak


\newpage
\listoffigures
\newpage
\listoftables

\pagebreak

```{r llama codigos, warning=F, include=T, message=F, echo=FALSE }

library(stringr)
library(lattice)
library(ggplot2)
library(reshape)
library(dplyr)
library(ggthemes)
library(stringr)
library(knitr)
library(patchwork)
#library(kableExtra)

# FIGURAS
dir.Fig        <-"Figuras_Diagnostico/"
fig            <-c("pdf","bmp")


#DIRECTORIOS
carpetabase <-getwd()
dir.0       <-carpetabase
dir.1       <-paste(dir.0,"/codigos_admb",sep="")
dir.fun     <-paste(dir.0,"/funciones/",sep="")
dir.pbr     <-paste(dir.0,"/PBRs_Analisys",sep="")
```

```{r Modelo_BASE_XN, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXN")
system("./MAETXN")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAETXN") 
```


```{r ModeloALTERNATIVO_XN, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXNa")
system("./MAETXNa")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAETXNa") 
```


```{r ModeloBASE_XS, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXS")
system("./MAETXS")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAETXS") 
```


```{r ModeloALTERNATIVO_XS, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXSa")
system("./MAETXSa")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAETXSa") 
```

```{r ModeloBASE_XI, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXI")
system("./MAETXI")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAETXI") 

```


```{r ModeloALTERNATIVO_XI, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXIa")
system("./MAETXIa")

source(paste(dir.fun,"removefile.R",sep=""))
removefileadmb(dir.1,"MAETXIa") 

```


```{r lee_datosModeloBASE, echo=F, warning=FALSE}
source(paste(dir.fun,"functions.R",sep=""))
setwd(dir.1)

# Zona X Norte
data1        <- lisread("MAETXN.dat") 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist("MAETXN.rep")
std1         <- read.table("MAETXN.std",header=T,sep="",na="NA",fill=T) 

# Zona X Sur
data2        <- lisread("MAETXS.dat") 
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data2
rep2         <- reptoRlist("MAETXS.rep")
std2         <- read.table("MAETXS.std",header=T,sep="",na="NA",fill=T) 

# Zona XI
data3        <- lisread("MAETXI.dat") 
names(data3) <- str_trim(names(data3), side="right")
dat3         <- data3
rep3         <- reptoRlist("MAETXI.rep")
std3         <- read.table("MAETXI.std",header=T,sep="",na="NA",fill=T) 


```


```{r lee_datosModeloALTERNATIVO, echo=F, warning=FALSE}
source(paste(dir.fun,"functions.R",sep=""))
setwd(dir.1)

# Zona X Norte
data1a        <- lisread("MAETXNa.dat") 
names(data1a) <- str_trim(names(data1a), side="right")
dat1a         <- data1a
rep1a         <- reptoRlist("MAETXNa.rep")
std1a         <- read.table("MAETXNa.std",header=T,sep="",na="NA",fill=T) 

# Zona X Sur
data2a        <- lisread("MAETXSa.dat") 
names(data2a) <- str_trim(names(data2a), side="right")
dat2a         <- data2a
rep2a         <- reptoRlist("MAETXSa.rep")
std2a         <- read.table("MAETXSa.std",header=T,sep="",na="NA",fill=T) 

# Zona XI
data3a        <- lisread("MAETXIa.dat") 
names(data3a) <- str_trim(names(data3a), side="right")
dat3a         <- data3a
rep3a         <- reptoRlist("MAETXIa.rep")
std3a         <- read.table("MAETXIa.std",header=T,sep="",na="NA",fill=T) 


```


```{r RetrospectivoXN, echo=F, warning=FALSE,eval=F,include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAETXN",dir.0,dir.1,"/RetrospectivoXN") 

```


```{r RetrospectivoXS, echo=F, warning=FALSE,eval=F,include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAETXS",dir.0,dir.1,"/RetrospectivoXS") 

```


```{r RetrospectivoXI, echo=F, warning=FALSE,eval=F,include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAETXI",dir.0,dir.1,"/RetrospectivoXI") 

```


```{r VerosimilitudXN, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 3.17467674069
priorRo <- seq(1.9,4.1,0.1)
Verosimilitud("MAETXN",dir.0,dir.1,"/VerosimilitudXN",logRo,priorRo) 

```


```{r VerosimilitudXS, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 4.58827404901
priorRo <- seq(4,9,0.2)
Verosimilitud("MAETXS",dir.0,dir.1,"/VerosimilitudXS",logRo,priorRo) 

```


```{r VerosimilitudXI, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 4.89072430364
priorRo <- seq(4,6,0.1)
Verosimilitud("MAETXI",dir.0,dir.1,"/VerosimilitudXI",logRo,priorRo) 

```

```{r MortalidadNaturalXN, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_MortalidadNatural.R",sep=""))
rango_M   <-seq(0.15, 0.25, 0.01)
MortalidadNatural("MAETXN",dir.0,dir.1,"/MortalidadNatural_XN",rango_M) 
```

```{r MortalidadNaturalXS, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_MortalidadNatural.R",sep=""))
rango_M   <-seq(0.22, 0.32, 0.01)
MortalidadNatural("MAETXS",dir.0,dir.1,"/MortalidadNatural_XS",rango_M) 
```

```{r MortalidadNaturalXI, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_MortalidadNatural.R",sep=""))
rango_M   <-seq(0.15, 0.25, 0.01)
MortalidadNatural("MAETXI",dir.0,dir.1,"/MortalidadNatural_XI",rango_M) 
```

```{r Rango_Loo_XN, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_Rango_Loo.R",sep=""))
rango_Loo   <-seq(128, 136, 0.5)

Rango_Loo("MAETXN",dir.0,dir.1,"/RangoLoo_XN",rango_Loo) 
```

```{r Rango_Loo_XS, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_Rango_Loo.R",sep=""))
rango_Loo   <-seq(116, 128, 0.5)
Rango_Loo("MAETXS",dir.0,dir.1,"/RangoLoo_XS",rango_Loo) 
```

```{r Rango_Loo_XI, echo=F, warning=F,eval=F,include=F}
source(paste(dir.fun,"Fn_Rango_Loo.R",sep=""))
rango_Loo   <-seq(128, 136, 0.5)
Rango_Loo("MAETXI",dir.0,dir.1,"/RangoLoo_XI",rango_Loo) 
```

```{r funcionPbr_Xnorte,echo=FALSE, message=FALSE, warning=FALSE, include=F,eval=T}

source(paste(dir.fun,"Fn_Frms.R",sep=""))
  dir.pbr     <-paste(dir.0,"/PBR_Analisys",sep="")
  admb <- "PBRmodbento"
  Carpeta<-"/Frms_XN"

years   <- rep1$years
nyears  <- length(years) 
M<-dat1$Loo_k_Lo_cv_M[5]
h<-dat1$h
dt<-dat1$dts[1]

Dat<-list()
# M_h_dtspawning
Dat$Mhdt<- c(M,	h,	dt)	
# Number_%BRP									
Dat$npbr<- 2
# SSB/SSBo									
Dat$pbrs<-c(0.2,	0.4)
# Number_ages									
Dat$nage<- 12
# Maturity_at_age									
Dat$madurez_age<-c(0.069,	0.243,	0.583,	0.859,	0.964,	0.991,	0.998,	1,	1,	1	,1,	1)
# Wt_at_age
Dat$Wt_age<- c(103.9503252,	138.1316778,	172.9477424,	207.3058951,	240.4212378,	271.7660199,	301.0155275,	328.0003793,	352.6699672,	375.0527626,	395.2273356,	413.32399870)
# yrs_of_selectivity									
Dat$nyears<-nyears
# Selectivity
Dat$sel_f <- rep1$Sel_f

  fn_Frms(admb,dir.0,dir.pbr,Carpeta,Dat)
  dir_pbrXN <- paste(dir.0,Carpeta,sep="")
  setwd(dir_pbrXN)
  rep_pbr1   <- reptoRlist("PBRmodbento.rep")
  
  
```

```{r funcionPbr_Xsur,echo=FALSE, message=FALSE, warning=FALSE, include=F,eval=T}

source(paste(dir.fun,"Fn_Frms.R",sep=""))
  dir.pbr     <-paste(dir.0,"/PBR_Analisys",sep="")
  admb <- "PBRmodbento"
  Carpeta<-"/Frms_XS"

years   <- rep2$years
nyears  <- length(years) 
M<-dat2$Loo_k_Lo_cv_M[5]
h<-dat2$h
dt<-dat2$dts[1]

Dat<-list()
# M_h_dtspawning	
Dat$Mhdt<- c(M,	h,	dt)	
# Number_%BRP									
Dat$npbr<- 2
# SSB/SSBo									
Dat$pbrs<-c(0.2,	0.4)
# Number_ages									
Dat$nage<- 12
# Maturity_at_age									
Dat$madurez_age<-c(0.069,	0.243,	0.583,	0.859,	0.964,	0.992,	1,	1.003,	1.005,	1.008,	1.012,	1.017)
# Wt_at_age
Dat$Wt_age<- c(65.47584468,	95.48639075,	127.5619035,	160.3247821,	192.7228914,	223.9979339,	253.6364726,	281.31982,	306.8802903,	330.2630854,	351.4798174,	370.6309927)
# yrs_of_selectivity									
Dat$nyears<-nyears
# Selectivity
Dat$sel_f <- rep2$Sel_f

  fn_Frms(admb,dir.0,dir.pbr,Carpeta,Dat)
  dir_pbrXS <- paste(dir.0,Carpeta,sep="")
  setwd(dir_pbrXS)
  rep_pbr2   <- reptoRlist("PBRmodbento.rep")
  
```

```{r funcionPbr_XI,echo=FALSE, message=FALSE, warning=FALSE, include=F,eval=T}

 source(paste(dir.fun,"Fn_Frms.R",sep=""))
  dir.pbr     <-paste(dir.0,"/PBR_Analisys",sep="")
  admb <- "PBRmodbento"
  Carpeta<-"/Frms_XI"
  
  
years   <- rep3$years
nyears  <- length(years) 
M<-dat3$Loo_k_Lo_cv_M[5]
h<-dat3$h
dt<-dat3$dts[1]

Dat<-list()
# M_h_dtspawning
Dat$Mhdt<- c(M,	h,	dt)	
# Number_%BRP									
Dat$npbr<- 2
# SSB/SSBo									
Dat$pbrs<-c(0.2,	0.4)
# Number_ages									
Dat$nage<- 12
# Maturity_at_age									
Dat$madurez_age<-c(0.069,	0.243,	0.583,	0.859,	0.964,	0.992,	1,	1.003,	1.005,	1.008,	1.012,	1.017)
# Wt_at_age
Dat$Wt_age<- c(65.47584468,	95.48639075,	127.5619035,	160.3247821,	192.7228914,	223.9979339,	253.6364726,	281.31982,	306.8802903,	330.2630854,	351.4798174,	370.6309927)
# yrs_of_selectivity									
Dat$nyears<-nyears
# Selectivity
Dat$sel_f <- rep3$Sel_f

  fn_Frms(admb,dir.0,dir.pbr,Carpeta,Dat)
  dir_pbrXI <- paste(dir.0,Carpeta,sep="")
  setwd(dir_pbrXI)
  rep_pbr3   <- reptoRlist("PBRmodbento.rep")
  
```

# 1. Erizo Zona X Norte

## 1.1. Ajustes y residuos

```{r Dat_Ajustes_indices, echo=FALSE, message=FALSE, warning=FALSE, include=T}

yrs   <- rep1$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvcpue   <-0.20
cvdes   <-0.05
######################################################
# Erizo X Norte
######################################################
ind_obsXN               <- cbind(rep1$CPUE_obs, 
                                 rep1$Desemb_obs); 
ind_obsXN[ind_obsXN==0] <- NA
colnames(ind_obsXN)     <- c('CPUE', 'Desembarques') 
indXN                   <- data.frame(ind_obsXN) %>% 
                            mutate(Asesoria='observado') %>% 
                            mutate (yrs= yrs) %>% 
                            melt(id.var=c('yrs', 'Asesoria'))  

ind_predXN           <- cbind(c(rep1$CPUE_pred),
                              c(rep1$Desemb_pred)) 
colnames(ind_predXN) <- c('CPUE', 'Desembarques') 
predXN               <- data.frame(ind_predXN) %>% 
                        mutate (Asesoria='Índices') %>% 
                        mutate (yrs= yrs)  %>% 
                        melt(id.var=c('yrs', 'Asesoria'))

baseXN <- data.frame(rbind(indXN, predXN))  
######################################################
# Erizo X Sur
######################################################
ind_obsXS           <- cbind(rep2$CPUE_obs, 
                             rep2$Desemb_obs); 
ind_obsXS[ind_obsXS==0] <- NA
colnames(ind_obsXS) <- c('CPUE', 'Desembarques') 
indXS               <- data.frame(ind_obsXS) %>%
                        mutate(Asesoria='observado') %>% 
                        mutate (yrs= yrs) %>% 
                        melt(id.var=c('yrs', 'Asesoria'))  

ind_predXS           <- cbind(c(rep2$CPUE_pred), 
                              c(rep2$Desemb_pred)) 
colnames(ind_predXS) <- c('CPUE', 'Desembarques') 
predXS               <- data.frame(ind_predXS) %>% 
                        mutate (Asesoria='Índices') %>% 
                        mutate (yrs= yrs)  %>% 
                        melt(id.var=c('yrs', 'Asesoria'))

baseXS <- data.frame(rbind(indXS, predXS))  
######################################################
# Erizo XI
######################################################
ind_obsXI           <- cbind(rep3$CPUE_obs,
                             rep3$Desemb_obs); 
ind_obsXI[ind_obsXI==0] <- NA
colnames(ind_obsXI) <- c('CPUE', 'Desembarques') 
indXI               <- data.frame(ind_obsXI) %>%
                        mutate(Asesoria='observado') %>% 
                        mutate (yrs= yrs) %>%
                        melt(id.var=c('yrs', 'Asesoria'))  

ind_predXI           <- cbind(c(rep3$CPUE_pred), 
                              c(rep3$Desemb_pred)) 
colnames(ind_predXI) <- c('CPUE', 'Desembarques') 
predXI               <- data.frame(ind_predXI) %>% 
                        mutate (Asesoria='Índices') %>% 
                        mutate (yrs= yrs)  %>% 
                        melt(id.var=c('yrs', 'Asesoria'))

baseXI <- data.frame(rbind(indXI, predXI))  

```


```{r  Fig_ajustesIndices_XN, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center", fig.height=5,fig.width=5, fig.path=dir.Fig,  dev=fig, include=T, fig.cap="Modelo base. Ajuste del modelo a la información de CPUE, desembarque para el erizo de la zona X Norte. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La línea negra sólida muestra el valor estimado por el modelo"}

cpueXN <- ggplot(baseXN %>% filter(Asesoria!='observado', variable=='CPUE'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXN %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXN %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Kg/hora') +
       theme_bw(base_size=9) + 
       ggtitle('CPUE zona X Norte')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXN <- ggplot(baseXN %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXN %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXN %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques zona X Norte')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXN/desXN + plot_layout(guides="collect")

```

\pagebreak


```{r Fig_residuosIndices_XN,warning=F, include=T, message=F, echo=F,fig.height=5,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Residuos de la CPUE y desembarques de erizo de la zona X Norte"}


yrs      <- rep1$years
ind_obs  <- cbind(rep1$CPUE_obs,
                  rep1$Desemb_obs); 

ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('CPUE', 
                       'Desembarques') 

ind_sept <- cbind(c(rep1$CPUE_pred), 
                  c(rep1$Desemb_pred))
colnames(ind_sept) <- c('CPUE', 
                       'Desembarques') 

ind     <- data.frame(ind_obs) %>% 
           mutate(Asesoría='observado') %>% 
           mutate (yrs= yrs) %>% 
           melt(id.var=c('yrs', 'Asesoría'))  

sept    <- data.frame(ind_sept) %>% 
           mutate (Asesoría='base') %>%
           mutate (yrs= yrs)  %>% 
           melt(id.var=c('yrs', 'Asesoría'))

base1 <- data.frame(rbind(ind, sept))  


Res_matt <- data.frame(log(ind_obs) - log(ind_sept)) %>% 
            mutate(yrs = yrs) %>% 
            mutate(Asesoría = 'base')

Res      <- rbind(Res_matt) %>%
            melt(id.vars= c('yrs','Asesoría'))
pred     <- base1 %>% 
            filter(Asesoría!='observado') %>% 
            mutate (pred = log(value))

predm    <- pred$pred
Res2     <- cbind(Res,predm)

###################################################################################################

r1.1  <-ggplot(filter(Res, Asesoría=='base'), aes(yrs,value)) + 
        geom_bar(stat='identity', position='dodge') +
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Año', y = 'Residuales (escala log)') +
        theme_bw(base_size=9)

r2.2  <-ggplot(filter(Res, Asesoría=='base'), aes(predm,value)) + 
        geom_point(size = 1.5) + 
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Predicho (log)', y = 'Residuales') + 
        theme_bw(base_size=8)

r3.3 <- ggplot(filter(Res, Asesoría=='base'), aes(value)) + 
        geom_histogram(fill='white', position  = 'dodge') +
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
        theme_bw(base_size=9)

r4.4 <- ggplot(filter(Res, Asesoría=='base'), aes(sample = value)) + 
        stat_qq() + 
        stat_qq_line() + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Sample Quantiles', y ='Theoretical') + 
        theme_bw(base_size=9)

r1.1 + r2.2 + r4.4

```

\pagebreak

```{r Dat_Ajustes_indicesMalt, echo=FALSE, message=FALSE, warning=FALSE, include=T}

yrs   <- rep1a$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvcpue   <-0.20
cvdes   <-0.05
######################################################
# Erizo X Norte
######################################################
ind_obsXN               <- cbind(rep1a$CPUE_obs, 
                                 rep1a$Desemb_obs); 
ind_obsXN[ind_obsXN==0] <- NA
colnames(ind_obsXN)     <- c('Biomasa', 'Desembarques') 

indXN                   <- data.frame(ind_obsXN) %>% 
                            mutate(Asesoria='observado') %>% 
                            mutate (yrs= yrs) %>% 
                            melt(id.var=c('yrs', 'Asesoria'))  

ind_predXN           <- cbind(c(rep1a$CPUE_pred), 
                              c(rep1a$Desemb_pred)) 
colnames(ind_predXN) <- c('Biomasa', 'Desembarques') 

predXN               <- data.frame(ind_predXN) %>% 
                        mutate (Asesoria='Índices') %>% 
                        mutate (yrs= yrs)  %>% 
                        melt(id.var=c('yrs', 'Asesoria'))

baseXN <- data.frame(rbind(indXN, predXN))  
######################################################
# Erizo X Sur
######################################################
ind_obsXS           <- cbind(rep2a$CPUE_obs, 
                             rep2a$Desemb_obs); 
ind_obsXS[ind_obsXS==0] <- NA
colnames(ind_obsXS) <- c('Biomasa', 'Desembarques') 
indXS               <- data.frame(ind_obsXS) %>% 
                        mutate(Asesoria='observado') %>% 
                        mutate (yrs= yrs) %>% 
                        melt(id.var=c('yrs', 'Asesoria'))  

ind_predXS           <- cbind(c(rep2a$CPUE_pred), 
                              c(rep2a$Desemb_pred)) 
colnames(ind_predXS) <- c('Biomasa', 'Desembarques') 

predXS               <- data.frame(ind_predXS) %>% 
                        mutate (Asesoria='Índices') %>% 
                        mutate (yrs= yrs)  %>% 
                        melt(id.var=c('yrs', 'Asesoria'))

baseXS <- data.frame(rbind(indXS, predXS))  
######################################################
# Erizo XI
######################################################
ind_obsXI           <- cbind(rep3a$CPUE_obs, 
                             rep3a$Desemb_obs); 
ind_obsXI[ind_obsXI==0] <- NA
colnames(ind_obsXI) <- c('Biomasa', 'Desembarques') 

indXI               <- data.frame(ind_obsXI) %>% 
                        mutate(Asesoria='observado') %>% 
                        mutate (yrs= yrs) %>% 
                        melt(id.var=c('yrs', 'Asesoria'))  

ind_predXI           <- cbind(c(rep3a$CPUE_pred), 
                              c(rep3a$Desemb_pred)) 
colnames(ind_predXI) <- c('Biomasa', 'Desembarques') 

predXI               <- data.frame(ind_predXI) %>% 
                        mutate (Asesoria='Índices') %>% 
                        mutate (yrs= yrs)  %>% 
                        melt(id.var=c('yrs', 'Asesoria'))

baseXI <- data.frame(rbind(indXI, predXI))  

```

```{r  Fig_ajustesIndicesMalt_XN, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center", fig.height=5, fig.width=5,fig.path=dir.Fig,  dev=fig, include=T, fig.cap="Modelo alternativo. Ajuste del modelo a la información de Biomasa, desembarque para el erizo de la zona X Norte. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La línea negra sólida muestra el valor estimado por el modelo"}

cpueXN <- ggplot(baseXN %>% filter(Asesoria!='observado', variable=='Biomasa'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXN %>% filter(Asesoria=='observado', variable=='Biomasa'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXN %>% filter(Asesoria=='observado', variable=='Biomasa'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Biomasa zona X Norte - Modelo alternativo')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXN <- ggplot(baseXN %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXN %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXN %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques zona X Norte - Modelo alternativo')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXN/desXN + plot_layout(guides="collect")

```

\pagebreak


```{r Fig_residuosIndicesMalt_XN,warning=F, include=T, message=F, echo=F,fig.height=5,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo alternativo. Residuos de la CPUE y desembarques de erizo de la zona X Norte"}


yrs      <- rep1a$years
ind_obs  <- cbind(rep1a$CPUE_obs,
                  rep1a$Desemb_obs); 

ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('Biomasa', 
                       'Desembarques') 

ind_sept <- cbind(c(rep1a$CPUE_pred), 
                  c(rep1a$Desemb_pred))
colnames(ind_sept) <- c('Biomasa', 
                       'Desembarques') 

ind     <- data.frame(ind_obs) %>% 
           mutate(Asesoría='observado') %>% 
           mutate (yrs= yrs) %>% 
           melt(id.var=c('yrs', 'Asesoría'))  

sept    <- data.frame(ind_sept) %>% 
           mutate (Asesoría='base') %>%
           mutate (yrs= yrs)  %>% 
           melt(id.var=c('yrs', 'Asesoría'))

base1 <- data.frame(rbind(ind, sept))  


Res_matt <- data.frame(log(ind_obs) - log(ind_sept)) %>% 
            mutate(yrs = yrs) %>% 
            mutate(Asesoría = 'base')

Res      <- rbind(Res_matt) %>%
            melt(id.vars= c('yrs','Asesoría'))
pred     <- base1 %>% 
            filter(Asesoría!='observado') %>% 
            mutate (pred = log(value))

predm    <- pred$pred
Res2     <- cbind(Res,predm)

###################################################################################################

r1.1  <-ggplot(filter(Res, Asesoría=='base'), aes(yrs,value)) + 
        geom_bar(stat='identity', position='dodge') +
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Año', y = 'Residuales (escala log)') +
        theme_bw(base_size=9)

r2.2  <-ggplot(filter(Res, Asesoría=='base'), aes(predm,value)) + 
        geom_point(size = 1.5) + 
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Predicho (log)', y = 'Residuales') + 
        theme_bw(base_size=8)

r3.3 <- ggplot(filter(Res, Asesoría=='base'), aes(value)) + 
        geom_histogram(fill='white', position  = 'dodge') +
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
        theme_bw(base_size=9)

r4.4 <- ggplot(filter(Res, Asesoría=='base'), aes(sample = value)) + 
        stat_qq() + 
        stat_qq_line() + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Sample Quantiles', y ='Theoretical') + 
        theme_bw(base_size=9)

r1.1 + r2.2 + r4.4

```

\pagebreak

```{r Fig_ajustesCompFXN,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Ajuste del modelo a las estructuras de talla de las capturas de erizo zona X Norte. Las barras representan las proporciones de capturas observadas y las líneas, el ajuste del modelo. El modelo no ajusta para datos previos al año 1996."}

age  <-rep1$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep1$pobs)
etcf1_pre <- rbind(rep1$ppred) 

yearc1   <- rep1$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) +
          labs(x = 'Longitud', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA Zona X Norte - Mbase") + 
          theme(plot.title = element_text(size = 10)) +
          theme(plot.title = element_text(size = 6),axis.text = element_text(size = 6),
                strip.text.x = element_text(size=6),axis.title = element_text(size =6),legend.position="none")
  fig1

```

\pagebreak


```{r Fig_residuosCompXN,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Residuos de la proporción de tallas de erizo de la zona X Norte"}

ppredF <-rep1$ppred[37:61,]
anos   <-yrs[37:61]
obsF   <-rep1$pobs[37:61,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=0.8,cex.lab=0.8)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=1.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=1.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona X norte - Mbase",side=3,cex=1)
mtext("Edades",side=1,line=3.2,cex=1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1)
box()

```

\pagebreak


```{r Fig_ajustesCompFMalt_XN,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo alternativo. Ajuste del modelo a las estructuras de talla de las capturas de erizo zona X Norte. Las barras representan las proporciones de capturas observadas y las líneas, el ajuste del modelo. El modelo no ajusta para datos previos al año 1996."}

age  <-rep1a$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep1a$pobs)
etcf1_pre <- rbind(rep1a$ppred) 

yearc1   <- rep1a$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) +
          labs(x = 'Longitud', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA Zona X Norte - Malternativo") + 
          theme(plot.title = element_text(size = 10)) +
          theme(plot.title = element_text(size = 6),axis.text = element_text(size = 6),
                strip.text.x = element_text(size=6),axis.title = element_text(size =6),legend.position="none")
  fig1

```

\pagebreak


```{r Fig_residuosCompMalt_XN,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo alternativo. Residuos de la proporción de tallas de erizo de la zona X Norte"}

ppredF <-rep1$ppred[37:61,]
anos   <-yrs[37:61]
obsF   <-rep1$pobs[37:61,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=0.8,cex.lab=0.8)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=1.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=1.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona X norte - Malternativo",side=3,cex=1)
mtext("Edades",side=1,line=3.2,cex=1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1)
box()

```

\pagebreak

## 1.2. Análisis retrospectivo de erizo zona X norte

```{r VariablesXN_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep1$years
nyears<-length(years)

Rt1      <- subset(std1,name=="Rest")$value 
Rt1std   <- subset(std1,name=="Rest")$std
BT1      <- subset(std1,name=="BT")$value   
BT1std   <- subset(std1,name=="BT")$std
BD1      <- subset(std1,name=="BD")$value   
BD1std   <- subset(std1,name=="BD")$std
Ft1      <- subset(std1,name=="log_F")$value   
Ft1std   <- subset(std1,name=="log_F")$std

VarPob<- data.frame(x=years, Rt1=Rt1,BT1=BT1,BD1=BD1,Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std), upperRt1 = (Rt1+1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std), upperBT1 = (BT1+1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), upperBD1 = (BD1+1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), upperFt1 = exp(Ft1+1.96*Ft1std))

```

```{r Dat_RetrospectivoXN, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RetrospectivoXN",sep="")
setwd(dir)
admb<-"MAETXN"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$R_Est,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }


# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, y1=retroR[,2],y2=retroR[,3],y3=retroR[,4],y4=retroR[,5],y5=retroR[,6],
                      lower = (Rt1 -1.96*Rt1std), upper = (Rt1+1.96*Rt1std))
BD_retro<- data.frame(x=years, y1=retroBD[,2],y2=retroBD[,3],y3=retroBD[,4],y4=retroBD[,5],y5=retroBD[,6],
                      lower = (BD1 -1.96*BD1std), upper = (BD1+1.96*BD1std))
Ft_retro<- data.frame(x=years, y1=retroF[,2],y2=retroF[,3],y3=retroF[,4],y4=retroF[,5],y5=retroF[,6], 
                      lower = exp(Ft1-1.96*Ft1std), upper = exp(Ft1+1.96*Ft1std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, y1=rel.diff.r[,1],y2=rel.diff.r[,2],y3=rel.diff.r[,3],y4=rel.diff.r[,4],y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, y1=rel.diff.ssb[,1],y2=rel.diff.ssb[,2],y3=rel.diff.ssb[,3],y4=rel.diff.ssb[,4],y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, y1=rel.diff.f[,1],y2=rel.diff.f[,2],y3=rel.diff.f[,3],y4=rel.diff.f[,4],y5=rel.diff.f[,5])

```

```{r Fig_RetrospectivoXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Patrón retrospectivo estándar (panel izquierdo) y  relativo (panel derecho)", fig.height=6.5, fig.width=6}

#Retrospectivo tradicional
Rt <- ggplot(Rt_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = '',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = '',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

\pagebreak

## 1.3. Perfil de verosimilitud de erizo zona X norte


```{r Fig_VerosimilitudXN,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Perfil de verosimilitud erizo zona X norte", fig.height=5, fig.width=7}

source(paste(dir.fun,"functions.R",sep=""))
dir       <-paste(dir.0,"/VerosimilitudXN",sep="")
setwd(dir)

casos <-23
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=5,nrow=casos)
slikeval <- matrix(ncol=6,nrow=casos)


for(i in 1:casos){
report      <- reptoRlist(paste(dir,"//MAETXNs",i,".rep",sep=""))
logRo[i]    <- report$Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)  

# busca el mínimo
for(i in 1:6){
  slikeval[,i]<-like[,i]-minLik[i]
  }    # Estandarización

names<-c("Ro","CPUE","Desembarques","Prop_Flota","devRo","log_F","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2<- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names


fig1<-ggplot() +
      geom_line(aes(x = TLk2$Ro, y = TLk2$CPUE, colour=names[2])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Desembarques,colour=names[3])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Prop_Flota,colour=names[4])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Total,colour=names[7])) +
      geom_hline(yintercept = 2,colour='black',lty=2) +
      scale_colour_manual("",values=c("green","blue","red","black"))+
      coord_cartesian(xlim = c(0.5,45), ylim = c(0, 3))+
      xlab("Ro") + 
      ylab("L-min(L)") + 
     ggtitle("Erizo Zona X Norte - Modelo base")+
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")
     


     
fig1

```


\pagebreak

## 1.4. Análisis de sensibilidad a la Mortalidad natural - Modelo base


```{r Dat_SenMortalidadNatural_XN, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/MortalidadNatural_XN",sep="")
setwd(dir)
admb<-"MAETXN"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,11)
nretros<-length(retros)

retroBT      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)

for(i in 1:nretros){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroBT[,i] <- c(rep$BT)
  retroBD[,i] <- c(rep$BD)
  retroF[,i]  <- c(rep$F) }
  colnames(retroBT)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroBD)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroF)<-paste("y",seq(1,nretros,1),sep="")

dataBT <- as.data.frame(retroBT) %>% mutate(year=years) %>% melt(id.vars='year')
dataBD <- as.data.frame(retroBD) %>% mutate(year=years) %>% melt(id.vars='year')
dataF <- as.data.frame(retroF) %>% mutate(year=years) %>% melt(id.vars='year')

```

```{r Fig_MortalidadNatural_XN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Análisis de sensibilidad de la Mortalidad natural de erizo de la zona norte. La línea negra y zona sombreada corresponde a caso base (Loo = 119.85 mm y M = 0.25 año-1)", fig.height=6, fig.width=6}


BT <- ggplot() + 
      geom_ribbon(data=VarPob, aes(ymin=lowerBT1, ymax=upperBT1, x=x, fill = "IC"), alpha = 0.2)+
      geom_line(data=dataBT, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BT1, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa total',colour='Mortalidad natural')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('Sensibilidad a la Mortalidad natural')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BD <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataBD,aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BD1, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa desovante',colour='Mortalidad natural')  +
       scale_colour_discrete(breaks=paste("y",seq(1,nretros,1),sep=""),
                            labels=seq(0.15, 0.25, 0.01)) +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5))


Ft <- ggplot() + 
      geom_line(data=dataF, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=exp(Ft1), x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Mortalidad por pesca',colour='Mortalidad natural')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BT/BD/Ft

```

\pagebreak

## 1.5. Análisis de sensibilidad a la Longitud asintótica - Modelo base

```{r Dat_SenLoo_XN, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RangoLoo_XN",sep="")
setwd(dir)
admb<-"MAETXN"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,17)
nretros<-length(retros)

retroBT      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)

for(i in 1:nretros){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroBT[,i] <- c(rep$BT)
  retroBD[,i] <- c(rep$BD)
  retroF[,i]  <- c(rep$F) }
  colnames(retroBT)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroBD)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroF)<-paste("y",seq(1,nretros,1),sep="")

dataBT <- as.data.frame(retroBT) %>% mutate(year=years) %>% melt(id.vars='year')
dataBD <- as.data.frame(retroBD) %>% mutate(year=years) %>% melt(id.vars='year')
dataF <- as.data.frame(retroF) %>% mutate(year=years) %>% melt(id.vars='year')

```

```{r Fig_Loo_XN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Análisis de sensibilidad del rango de Loo de erizo de la zona norte. La línea negra y zona sombreada corresponde a caso base (Loo = 119.85 mm y M = 0.25 año-1)", fig.height=6, fig.width=6}


BT <- ggplot() + 
      geom_ribbon(data=VarPob, aes(ymin=lowerBT1, ymax=upperBT1, x=x, fill = "IC"), alpha = 0.2)+
      geom_line(data=VarPob,aes(y=BT1, x=years), colour=1, size=0.5)+
      geom_line(data=dataBT, aes(y=value, x=year, colour = variable), size=0.5)+
      labs(x = '', y = 'Biomasa total',colour='Loo')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('Sensibilidad a la Longitud asintótica (Loo)')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BD <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=VarPob,aes(y=BD1, x=years), colour=1, size=0.5)+
      geom_line(data=dataBD,aes(y=value, x=year, colour = variable), size=0.5)+
      labs(x = '', y = 'Biomasa desovante',colour='Loo')  +
       scale_colour_discrete(breaks=paste("y",seq(1,nretros,1),sep=""),
                            labels=seq(128, 136, 0.5)) +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
       scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5))


Ft <- ggplot() + 
      geom_line(data=dataF, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=exp(Ft1), x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Mortalidad por pesca',colour='Loo')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BT/BD/Ft

```

\pagebreak

## 1.6. Variables de estado

```{r Fig_VarpoblXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Variables de biomasas totales, desovantes, reclutamientos y desvíos estimadas por el modelo para el erizo de la zona X Norte período 1960 - 2019.", fig.height=6, fig.width=8}


Rt <- ggplot(VarPob) + 
    geom_line(aes(y=Rt1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
    geom_ribbon(aes(ymin=lowerRt1, ymax=upperRt1, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BT <- ggplot(VarPob) + 
     geom_line(aes(y=BT1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBT1, ymax=upperBT1, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa total',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey45"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey45"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey45"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT | (BD/Ft)


```

\pagebreak

```{r Fig_SelFlotaXN,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Selectividad de la flota de la Zona X Norte"}
# ASESORIA DE SEPTIEMBRE
age<-rep1$Edades
par(mfrow=c(1,1),mar=c(4,4,1,1))
	plot(age,rep1$Sel_f[1,],type="l",lwd=2,las=1,ylim=c(0,1.1),ylab="Selectividad",xlab="Edad (año)")
	lines(age,rep1$Sel_f[44,],type="o",pch="o")
	legend (6,0.5,c("sel_bloque (1960-2002)","sel_bloque (2003-2020)"),pch=c("","o"),lwd=c(2,1),bty='n',cex=0.8)

```

\pagebreak

## 1.7. Puntos Biológicos de Referencia

```{r Fig_PBRsXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Puntos Biológicos de referencia de Erizo zona X Norte", fig.height=4.5, fig.width=4.5,eval=T}

Frms<-rep_pbr1$`F(%SSBo)`[2,]
BDo<-rep1$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
     geom_hline(yintercept = c(BDrms,BDlim,BDo),colour=c('green3','red','blue'))+
  annotate("text", x=c(rep(2012,3)), y=c(BDrms,BDlim,BDo),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]))) +
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey45"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_line(aes(y=Frms, x=x), colour="green",size=0.5)+
     annotate("text", x=c(2011), y=c(Frms[nyears]),label=c(expression("F"[RMS]))) +
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black")) +
    scale_fill_manual("",values=c("grey45")) +
    theme_bw(base_size=8) +
     ggtitle('') +
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

 BD/Ft


```

\pagebreak

## 1.8. Estatus del erizo de la zona norte de la Región de Los Lagos

```{r Fig_DiagramaFaseXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Diagrama de fase propuesto para erizo zona X Norte",fig.height=4.5, fig.width=4.5,eval=T}
source(paste(dir.fun,"Fn_DiagramaFase.R",sep=""))

name0<-"Erizo Zona X Norte"
years0<-rep1$years
nyears0<-length(years0)
SSBt0         <- subset(std1,name=="BD")$value
SSBt0std      <- subset(std1,name=="BD")$std
Ft0           <- subset(std1,name=="log_F")$value
Ft0std        <- subset(std1,name=="log_F")$std
BDo0    <- rep1$BDo
BRMS0   <- BDo*0.4
FRMS0   <- rep_pbr1$`F(%SSBo)`[2,]

DiagramaFase(name0,FRMS0,BRMS0,SSBt0,SSBt0std,Ft0,Ft0std,years0,col_lastyear="blue",ylims=6,xlims=3)


```



\pagebreak

# 2. Erizo zona X Sur 

## 2.1. Ajustes y residuos

```{r Fig_ajustesIndices_XS, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center",fig.path=dir.Fig, fig.height=5,  fig.width=5, dev=fig, include=T, fig.cap="Modelo base. Ajuste del modelo a la información de CPUE, desembarque para el erizo de la zona X Sur. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La línea negra sólida muestra el valor estimado por el modelo"}

cpueXS <- ggplot(baseXS %>% filter(Asesoria!='observado', variable=='CPUE'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXS %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXS %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = ' Kg/hora') +
       theme_bw(base_size=9) + 
       ggtitle('CPUE zona X Sur')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXS <- ggplot(baseXS %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXS %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXS %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques zona X Sur')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXS/desXS + plot_layout(guides="collect")

```

\pagebreak



```{r Fig_residuosIndices_XS,warning=F, include=T, message=F, echo=F,fig.height=5,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Residuos de la CPUE y desembarques de erizo de la zona X Sur"}


yrs      <- rep2$years
ind_obs  <- cbind(rep2$CPUE_obs,
                  rep2$Desemb_obs); 

ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('CPUE', 
                       'Desembarques') 

ind_sept <- cbind(c(rep2$CPUE_pred), 
                  c(rep2$Desemb_pred))
colnames(ind_sept) <- c('CPUE', 
                       'Desembarques') 

ind     <- data.frame(ind_obs) %>% 
           mutate(Asesoría='observado') %>% 
           mutate (yrs= yrs) %>% 
           melt(id.var=c('yrs', 'Asesoría'))  

sept    <- data.frame(ind_sept) %>% 
           mutate (Asesoría='base') %>%
           mutate (yrs= yrs)  %>% 
           melt(id.var=c('yrs', 'Asesoría'))

base1 <- data.frame(rbind(ind, sept))  


Res_matt <- data.frame(log(ind_obs) - log(ind_sept)) %>% 
            mutate(yrs = yrs) %>% 
            mutate(Asesoría = 'base')

Res      <- rbind(Res_matt) %>%
            melt(id.vars= c('yrs','Asesoría'))
pred     <- base1 %>% 
            filter(Asesoría!='observado') %>% 
            mutate (pred = log(value))

predm    <- pred$pred
Res2     <- cbind(Res,predm)

###################################################################################################

r1.1  <-ggplot(filter(Res, Asesoría=='base'), aes(yrs,value)) + 
        geom_bar(stat='identity', position='dodge') +
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Año', y = 'Residuales (escala log)') +
        theme_bw(base_size=9)

r2.2  <-ggplot(filter(Res, Asesoría=='base'), aes(predm,value)) + 
        geom_point(size = 1.5) + 
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Predicho (log)', y = 'Residuales') + 
        theme_bw(base_size=8)

r3.3 <- ggplot(filter(Res, Asesoría=='base'), aes(value)) + 
        geom_histogram(fill='white', position  = 'dodge') +
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
        theme_bw(base_size=9)

r4.4 <- ggplot(filter(Res, Asesoría=='base'), aes(sample = value)) + 
        stat_qq() + 
        stat_qq_line() + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Sample Quantiles', y ='Theoretical') + 
        theme_bw(base_size=9)

r1.1 + r2.2 + r4.4

```

\pagebreak

```{r ajustesCompFXS,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig,  fig.cap="Modelo base. Ajustes de la proporción de tallas de erizo de la zona X Sur"}
age  <-rep2$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep2$pobs)
etcf1_pre <- rbind(rep2$ppred) 

yearc1   <- rep2$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA Zona X Sur") + 
          theme(plot.title = element_text(size = 10)) +
          theme(plot.title = element_text(size = 6),axis.text = element_text(size = 6),
                strip.text.x = element_text(size=6),axis.title = element_text(size =6),legend.position="none")
  fig1

```


\pagebreak

```{r Fig_residuosCompXS,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Residuos de la proporción de tallas de erizo de la zona X sur"}

ppredF <-rep2$ppred[28:61,]
anos   <-yrs[28:61]
obsF   <-rep2$pobs[28:61,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=0.8,cex.lab=0.8)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=1.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=1.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona X sur",side=3,cex=1)
mtext("Edades",side=1,line=3.2,cex=1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1)
box()

```

\pagebreak

## 2.2. Análisis retrospectivo de erizo zona X sur - modelo base

```{r VariablesXS_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep2$years
nyears<-length(years)

Rt2      <- subset(std2,name=="Rest")$value 
Rt2std   <- subset(std2,name=="Rest")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="BD")$value   
BD2std   <- subset(std2,name=="BD")$std
Ft2      <- subset(std2,name=="log_F")$value   
Ft2std   <- subset(std2,name=="log_F")$std

VarPob<- data.frame(x=years, 
                    Rt2=Rt2,
                    BT2=BT2,
                    BD2=BD2,
                    Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std), upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), upperFt2 = exp(Ft2+1.96*Ft2std))

```

```{r Dat_RetrospectivoXS, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RetrospectivoXS",sep="")
setwd(dir)
admb<-"MAETXS"

years<-rep2$years
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$R_Est,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }



# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, 
                      y1=retroR[,2],
                      y2=retroR[,3],
                      y3=retroR[,4],
                      y4=retroR[,5],
                      y5=retroR[,6],
                      lower = (Rt2 -1.96*Rt2std), 
                      upper = (Rt2+1.96*Rt2std))
BD_retro<- data.frame(x=years,
                      y1=retroBD[,2],
                      y2=retroBD[,3],
                      y3=retroBD[,4],
                      y4=retroBD[,5],
                      y5=retroBD[,6],
                      lower = (BD2 -1.96*BD2std),
                      upper = (BD2+1.96*BD2std))
Ft_retro<- data.frame(x=years, 
                      y1=retroF[,2],
                      y2=retroF[,3],
                      y3=retroF[,4],
                      y4=retroF[,5],
                      y5=retroF[,6], 
                      lower = exp(Ft2-1.96*Ft2std), 
                      upper = exp(Ft2+1.96*Ft2std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years,
                         y1=rel.diff.r[,1],
                         y2=rel.diff.r[,2],
                         y3=rel.diff.r[,3],
                         y4=rel.diff.r[,4],
                         y5=rel.diff.r[,5])

BD_retroRel<- data.frame(x=years,
                         y1=rel.diff.ssb[,1],
                         y2=rel.diff.ssb[,2],
                         y3=rel.diff.ssb[,3],
                         y4=rel.diff.ssb[,4],
                         y5=rel.diff.ssb[,5])

Ft_retroRel<- data.frame(x=years,
                         y1=rel.diff.f[,1],
                         y2=rel.diff.f[,2],
                         y3=rel.diff.f[,3],
                         y4=rel.diff.f[,4],
                         y5=rel.diff.f[,5])



```

```{r Fig_RetrospectivoXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Patrón retrospectivo estándar (panel izquierdo) y  relativo (panel derecho) de los reclutamientos", fig.path=dir.Fig,fig.height=6.5, fig.width=6}

Rt <- ggplot(Rt_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = '',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = '',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

\pagebreak

## 2.3. Perfil de verosimilitud de erizo zona X sur - modelo base

```{r Fig_VerosimilitudXS,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Perfil de verosimilitud erizo zona X sur", fig.height=5, fig.width=7}

source(paste(dir.fun,"functions.R",sep=""))
dir       <-paste(dir.0,"/VerosimilitudXS",sep="")
setwd(dir)

casos <-26
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=10,nrow=casos)
slikeval <- matrix(ncol=11,nrow=casos)

for(i in 1:casos){
report      <- reptoRlist(paste(dir,"/MAETXSs",i,".rep",sep=""))
logRo[i]    <- report$Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)                         # busca el mínimo
for(i in 1:11){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarización


names<-c("Ro","CPUE","Desembarques","Prop_Flota","devRo","log_F","NA","NA","NA","NA","NA","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2<- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names


fig1<-ggplot() +
      geom_line(aes(x = TLk2$Ro, y = TLk2$CPUE, colour=names[2])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Desembarques,colour=names[3])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Prop_Flota,colour=names[4])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Total,colour=names[12])) +
      geom_hline(yintercept = 2,colour='black',lty=2) +
      scale_colour_manual("",values=c("green","blue","red","black"))+
      coord_cartesian(xlim = c(0.5,3000), ylim = c(0, 3))+
      xlab("Ro") + 
      ylab("L-min(L)") + 
     ggtitle("Erizo Zona X Sur - Modelo base")+
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")
     


     
fig1

```


\pagebreak

## 2.4. Análisis de sensibilidad a la mortalidad natural 


```{r Dat_SenMortalidadNatural_XS, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/MortalidadNatural_XS",sep="")
setwd(dir)
admb<-"MAETXS"


years<-rep1$years
nyears<-length(years)
retros<-seq(1,11)
nretros<-length(retros)

retroBT      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)

for(i in 1:nretros){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroBT[,i] <- c(rep$BT)
  retroBD[,i] <- c(rep$BD)
  retroF[,i]  <- c(rep$F) }
  colnames(retroBT)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroBD)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroF)<-paste("y",seq(1,nretros,1),sep="")

dataBT <- as.data.frame(retroBT) %>% mutate(year=years) %>% melt(id.vars='year')
dataBD <- as.data.frame(retroBD) %>% mutate(year=years) %>% melt(id.vars='year')
dataF <- as.data.frame(retroF) %>% mutate(year=years) %>% melt(id.vars='year')

```

```{r Fig_MortalidadNatural_XS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Análisis de sensibilidad de la Mortalidad natural de erizo de la zona X sur. La línea negra y zona sombreada corresponde a caso base (Loo = 119.85 mm y M = 0.282 año-1)", fig.height=6, fig.width=6}


BT <- ggplot() + 
      geom_ribbon(data=VarPob, aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = "IC"), alpha = 0.2)+
      geom_line(data=dataBT, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BT2, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa total',colour='Mortalidad natural')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle(' Sensibilidad a la Mortalidad natural')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BD <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataBD,aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BD2, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa desovante',colour='Mortalidad natural')  +
       scale_colour_discrete(breaks=paste("y",seq(1,nretros,1),sep=""),
                            labels=seq(0.22, 0.32, 0.01)) +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5))


Ft <- ggplot() + 
      geom_line(data=dataF, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_ribbon(data=VarPob,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=VarPob,aes(y=Ft2, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Mortalidad por pesca',colour='Mortalidad natural')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BT/BD/Ft

```

\pagebreak

## 2.5. Análisis de sensibilidad a la  Longitud asintótica

```{r Dat_SenLoo_XS, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RangoLoo_XS",sep="")
setwd(dir)
admb<-"MAETXS"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,25)
nretros<-length(retros)

retroBT      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)

for(i in 1:nretros){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroBT[,i] <- c(rep$BT)
  retroBD[,i] <- c(rep$BD)
  retroF[,i]  <- c(rep$F) }
  colnames(retroBT)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroBD)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroF)<-paste("y",seq(1,nretros,1),sep="")

dataBT <- as.data.frame(retroBT) %>% mutate(year=years) %>% melt(id.vars='year')
dataBD <- as.data.frame(retroBD) %>% mutate(year=years) %>% melt(id.vars='year')
dataF <- as.data.frame(retroF) %>% mutate(year=years) %>% melt(id.vars='year')

```

```{r Fig_Loo_XS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Análisis de sensibilidad del rango de Loo de erizo de la zona X sur. La línea negra y zona sombreada corresponde a caso base (Loo = 119.85 mm y M = 0.282 año-1)", fig.height=6, fig.width=6}


BT <- ggplot() + 
      geom_ribbon(data=VarPob, aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = "IC"), alpha = 0.2)+
      geom_line(data=dataBT, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BT2, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa total',colour='Loo')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('Sensibilidad a la Longitud asintótica (Loo)')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BD <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataBD,aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BD2, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa desovante',colour='Loo')  +
       scale_colour_discrete(breaks=paste("y",seq(1,nretros,1),sep=""),
                            labels=seq(116, 128, 0.5)) +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5))


Ft <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataF, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=Ft2, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Mortalidad por pesca',colour='Loo')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BT/BD/Ft

```


\pagebreak

## 2.6. Variables de estado de erizo Zona X sur.

```{r Fig_VarpoblXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Variables poblacionales de Erizo zona X Sur", fig.path=dir.Fig,fig.height=6, fig.width=8}


Rt <- ggplot(VarPob) + 
    geom_line(aes(y=Rt2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
    geom_ribbon(aes(ymin=lowerRt2, ymax=upperRt2, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BT <- ggplot(VarPob) + 
     geom_line(aes(y=BT2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa total',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT | BD/Ft


```

```{r Fig_SelFlotaXS,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Selectividad de la flota de la Zona X sur"}
# ASESORIA DE SEPTIEMBRE
age<-rep2$Edades
par(mfrow=c(1,1),mar=c(4,4,1,1))
	plot(age,rep2$Sel_f[1,],type="l",lwd=2,las=1,ylim=c(0,1.1),ylab="Selectividad",xlab="Edad (año)")
	legend (6,0.5,c("sel_bloque (1960-2020)"),pch=c(""),lwd=c(2),bty='n',cex=0.8)

```


\pagebreak

## 2.7. Puntos Biológicos de Referencia

```{r Fig_PBRsXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Puntos Biológicos de referencia de Erizo zona X Sur", fig.height=4.5, fig.width=4.5,eval=T}

Frms<-rep_pbr2$`F(%SSBo)`[2,]
BDo<-rep2$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "IC"), alpha = 0.2)+
   geom_hline(yintercept = c(BDrms,BDlim,BDo),colour=c('green3','red','blue'))+
  annotate("text", x=c(rep(2012,3)), y=c(BDrms,BDlim,BDo),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]))) +
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
    geom_line(aes(y=Frms, x=x), colour="green",size=0.5)+
     annotate("text", x=c(2011), y=c(Frms[nyears]),label=c(expression("F"[RMS]))) +
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


 BD/Ft


```


\pagebreak

## 2.8. Estatus del erizo de la zona sur de la Región de Los Lagos

```{r Fig_DiagramaFaseXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Diagrama de fase propuesto para erizo zona X Sur",fig.height=4.5, fig.width=4.5,eval=T}

source(paste(dir.fun,"Fn_DiagramaFase.R",sep=""))

name0<-"Erizo Zona X Sur"
years0<-rep2$years
nyears0<-length(years0)

SSBt0         <- subset(std2,name=="BD")$value
SSBt0std      <- subset(std2,name=="BD")$std
Ft0           <- subset(std2,name=="log_F")$value
Ft0std        <- subset(std2,name=="log_F")$std
BDo0    <- rep2$BDo
BRMS0   <- BDo*0.4
FRMS0   <- rep_pbr2$`F(%SSBo)`[2,]

DiagramaFase(name0,FRMS0,BRMS0,SSBt0,SSBt0std,Ft0,Ft0std,years0,col_lastyear="blue",ylims=4,xlims=3)


```


\pagebreak

# 3. Erizo zona XI

## 3.1. Ajustes y residuos de erizo zona XI

```{r Fig_ajustesIndices_XI, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center", fig.height=6, fig.path=dir.Fig, fig.width=6, dev=fig, include=T, fig.cap="Modelo base. Ajuste del modelo a la información de CPUE, desembarque para el erizo de la zona X Sur. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La línea negra sólida muestra el valor estimado por el modelo"}

cpueXI <- ggplot(baseXI %>% filter(Asesoria!='observado', variable=='CPUE'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXI %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXI %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2021, by = 5)) +
       labs(x = '', y = 'Kg/hora') +
       theme_bw(base_size=9) + 
       ggtitle('CPUE zona XI')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXI <- ggplot(baseXI %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXI %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXI %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques zona XI')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXI/desXI + plot_layout(guides="collect")


```

\pagebreak

```{r Fig_residuosIndices_XI,warning=F, include=T, message=F, echo=F,fig.height=5,fig.width=7,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Residuos de la CPUE y desembarques de erizo de la zona XI"}


yrs      <- rep3$years
ind_obs  <- cbind(rep3$CPUE_obs,
                  rep3$Desemb_obs); 

ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('CPUE', 
                       'Desembarques') 

ind_sept <- cbind(c(rep3$CPUE_pred), 
                  c(rep3$Desemb_pred))
colnames(ind_sept) <- c('CPUE', 
                       'Desembarques') 

ind     <- data.frame(ind_obs) %>% 
           mutate(Asesoría='observado') %>% 
           mutate (yrs= yrs) %>% 
           melt(id.var=c('yrs', 'Asesoría'))  

sept    <- data.frame(ind_sept) %>% 
           mutate (Asesoría='base') %>%
           mutate (yrs= yrs)  %>% 
           melt(id.var=c('yrs', 'Asesoría'))

base1 <- data.frame(rbind(ind, sept))  


Res_matt <- data.frame(log(ind_obs) - log(ind_sept)) %>% 
            mutate(yrs = yrs) %>% 
            mutate(Asesoría = 'base')

Res      <- rbind(Res_matt) %>%
            melt(id.vars= c('yrs','Asesoría'))
pred     <- base1 %>% 
            filter(Asesoría!='observado') %>% 
            mutate (pred = log(value))

predm    <- pred$pred
Res2     <- cbind(Res,predm)

###################################################################################################

r1.1  <-ggplot(filter(Res, Asesoría=='base'), aes(yrs,value)) + 
        geom_bar(stat='identity', position='dodge') +
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Año', y = 'Residuales (escala log)') +
        theme_bw(base_size=9)

r2.2  <-ggplot(filter(Res, Asesoría=='base'), aes(predm,value)) + 
        geom_point(size = 1.5) + 
        geom_hline(yintercept = 0) + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Predicho (log)', y = 'Residuales') + 
        theme_bw(base_size=8)

r3.3 <- ggplot(filter(Res, Asesoría=='base'), aes(value)) + 
        geom_histogram(fill='white', position  = 'dodge') +
        facet_wrap(. ~ variable, ncol = 1) + 
        labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
        theme_bw(base_size=9)

r4.4 <- ggplot(filter(Res, Asesoría=='base'), aes(sample = value)) + 
        stat_qq() + 
        stat_qq_line() + 
        facet_wrap(. ~ variable, ncol = 1) +
        labs(x= 'Sample Quantiles', y ='Theoretical') + 
        theme_bw(base_size=9)

r1.1 + r2.2 + r4.4

```

\pagebreak

```{r ajustesCompFXI,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Ajustes de la proporción de tallas de erizo de la zona XI"}
age  <-rep3$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep3$pobs)
etcf1_pre <- rbind(rep3$ppred) 

yearc1   <- rep3$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA zona XI") + 
          theme(plot.title = element_text(size = 10)) +
          theme(plot.title = element_text(size = 6),axis.text = element_text(size = 6),
                strip.text.x = element_text(size=6),axis.title = element_text(size =6),legend.position="none")
  fig1

```


```{r Fig_residuosCompXI,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Residuos de la proporción de tallas de erizo de la zona XI"}

ppredF <-rep3$ppred[29:61,]
anos   <-yrs[29:61]
obsF   <-rep3$pobs[29:61,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=0.8,cex.lab=0.8)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=1.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=1.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona XI",side=3,cex=1)
mtext("Edades",side=1,line=3.2,cex=1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1)
box()

```


\pagebreak

## 3.2. Análisis retrospectivo de erizo zona XI

```{r VariablesXI_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep3$years
nyears<-length(years)

Rt3      <- subset(std3,name=="Rest")$value 
Rt3std   <- subset(std3,name=="Rest")$std
BT3      <- subset(std3,name=="BT")$value   
BT3std   <- subset(std3,name=="BT")$std
BD3      <- subset(std3,name=="BD")$value   
BD3std   <- subset(std3,name=="BD")$std
Ft3      <- subset(std3,name=="log_F")$value   
Ft3std   <- subset(std3,name=="log_F")$std

VarPob<- data.frame(x=years, Rt3=Rt3,BT3=BT3,BD3=BD3,Ft3=exp(Ft3), 
         lowerRt3 = (Rt3 -1.96*Rt3std), upperRt3 = (Rt3+1.96*Rt3std),
         lowerBT3 = (BT3 -1.96*BT3std), upperBT3 = (BT3+1.96*BT3std),
         lowerBD3 = (BD3 -1.96*BD3std), upperBD3 = (BD3+1.96*BD3std),
         lowerFt3 = exp(Ft3 -1.96*Ft3std), upperFt3 = exp(Ft3+1.96*Ft3std))

```

```{r Dat_RetrospectivoXI, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RetrospectivoXI",sep="")
setwd(dir)
admb<-"MAETXI"

years<-rep3$years
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$R_Est,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }


# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, 
                      y1=retroR[,2],
                      y2=retroR[,3],
                      y3=retroR[,4],
                      y4=retroR[,5],
                      y5=retroR[,6],
                      lower = (Rt3 -1.96*Rt3std), 
                      upper = (Rt3+1.96*Rt3std))

BD_retro<- data.frame(x=years,
                      y1=retroBD[,2],
                      y2=retroBD[,3],
                      y3=retroBD[,4],
                      y4=retroBD[,5],
                      y5=retroBD[,6],
                      lower = (BD3 -1.96*BD3std), 
                      upper = (BD3+1.96*BD3std))

Ft_retro<- data.frame(x=years, 
                      y1=retroF[,2],
                      y2=retroF[,3],
                      y3=retroF[,4],
                      y4=retroF[,5],
                      y5=retroF[,6], 
                      lower = exp(Ft3-1.96*Ft3std), 
                      upper = exp(Ft3+1.96*Ft3std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years,
                         y1=rel.diff.r[,1],
                         y2=rel.diff.r[,2],
                         y3=rel.diff.r[,3],
                         y4=rel.diff.r[,4],
                         y5=rel.diff.r[,5])

BD_retroRel<- data.frame(x=years,
                         y1=rel.diff.ssb[,1],
                         y2=rel.diff.ssb[,2],
                         y3=rel.diff.ssb[,3],
                         y4=rel.diff.ssb[,4],
                         y5=rel.diff.ssb[,5])

Ft_retroRel<- data.frame(x=years,
                         y1=rel.diff.f[,1],
                         y2=rel.diff.f[,2],
                         y3=rel.diff.f[,3],
                         y4=rel.diff.f[,4],
                         y5=rel.diff.f[,5])

```

```{r Fig_RetrospectivoXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Patrón retrospectivo estándar (panel izquierdo) y  relativo (panel derecho) de los reclutamientos", fig.path=dir.Fig,fig.height=6.5, fig.width=6}

Rt <- ggplot(Rt_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = '',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = '',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

\pagebreak

## 3.3. Perfil de verosimilitud de erizo zona XI

```{r Fig_VerosimilitudXI,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Perfil de verosimilitud erizo zona XI", fig.height=5, fig.width=7}

source(paste(dir.fun,"functions.R",sep=""))

dir       <-paste(dir.0,"/VerosimilitudXI",sep="")
setwd(dir)

casos <-21
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=5,nrow=casos)
slikeval <- matrix(ncol=6,nrow=casos)

for(i in 1:casos){
report      <- reptoRlist(paste(dir,"/MAETXIs",i,".rep",sep=""))
logRo[i]    <- report$Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)                         # busca el mínimo
for(i in 1:6){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarización

names<-c("Ro","CPUE","Desembarques","Prop_Flota","devRo","log_F","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2<- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names


fig1<-ggplot() +
      geom_line(aes(x = TLk2$Ro, y = TLk2$CPUE, colour=names[2])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Desembarques,colour=names[3])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Prop_Flota,colour=names[4])) +
      geom_line(aes(x = TLk2$Ro, y = TLk2$Total,colour=names[7])) +
      geom_hline(yintercept = 2,colour='black',lty=2) +
      scale_colour_manual("",values=c("green","blue","red","black"))+
      coord_cartesian(xlim = c(55,250), ylim = c(0, 3))+
      xlab("Ro") + 
      ylab("L-min(L)") + 
     ggtitle("Erizo Zona XI - Modelo base")+
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")
     


     
fig1

```

\pagebreak

## 3.4. Análisis de sensibilidad a la mortalidad natural de erizo zona XI


```{r Dat_SenMortalidadNatural_XI, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/MortalidadNatural_XI",sep="")
setwd(dir)
admb<-"MAETXI"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,11)
nretros<-length(retros)

retroBT      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)

for(i in 1:nretros){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroBT[,i] <- c(rep$BT)
  retroBD[,i] <- c(rep$BD)
  retroF[,i]  <- c(rep$F) }
  colnames(retroBT)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroBD)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroF)<-paste("y",seq(1,nretros,1),sep="")

dataBT <- as.data.frame(retroBT) %>% mutate(year=years) %>% melt(id.vars='year')
dataBD <- as.data.frame(retroBD) %>% mutate(year=years) %>% melt(id.vars='year')
dataF <- as.data.frame(retroF) %>% mutate(year=years) %>% melt(id.vars='year')

```

```{r Fig_MortalidadNatural_XI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Análisis de sensibilidad de la Mortalidad natural de erizo de la zona XI. La línea negra y zona sombreada corresponde a caso base (Loo = 132.8 mm y M = 0.20 año-1)", fig.height=6, fig.width=6}


BT <- ggplot() + 
      geom_ribbon(data=VarPob, aes(ymin=lowerBT3, ymax=upperBT3, x=x, fill = "IC"), alpha = 0.2)+
      geom_line(data=dataBT, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BT3, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa total',colour='Mortalidad natural')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('Sensibilidad a la Mortalidad natural')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BD <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataBD,aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BD3, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa desovante',colour='Mortalidad natural')  +
       scale_colour_discrete(breaks=paste("y",seq(1,nretros,1),sep=""),
                            labels=seq(0.15, 0.25, 0.01)) +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
       scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5))


Ft <- ggplot() + 
      geom_line(data=dataF, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_ribbon(data=VarPob,aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=VarPob,aes(y=Ft3, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Mortalidad por pesca',colour='Mortalidad natural')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
       scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BT/BD/Ft

```

\pagebreak

## 3.5. Análisis de sensibilidad a la Longitud asintótica

```{r Dat_SenLoo_XI, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RangoLoo_XI",sep="")
setwd(dir)
admb<-"MAETXI"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,17)
nretros<-length(retros)

retroBT      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)

for(i in 1:nretros){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroBT[,i] <- c(rep$BT)
  retroBD[,i] <- c(rep$BD)
  retroF[,i]  <- c(rep$F) }
  colnames(retroBT)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroBD)<-paste("y",seq(1,nretros,1),sep="")
  colnames(retroF)<-paste("y",seq(1,nretros,1),sep="")

dataBT <- as.data.frame(retroBT) %>% mutate(year=years) %>% melt(id.vars='year')
dataBD <- as.data.frame(retroBD) %>% mutate(year=years) %>% melt(id.vars='year')
dataF <- as.data.frame(retroF) %>% mutate(year=years) %>% melt(id.vars='year')

```

```{r Fig_Loo_XI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Análisis de sensibilidad del rango de Loo de erizo de la zona XI. La línea negra y zona sombreada corresponde a caso base (Loo = 132.8 mm y M = 0.20 año-1)", fig.height=6, fig.width=6}


BT <- ggplot() + 
      geom_ribbon(data=VarPob, aes(ymin=lowerBT3, ymax=upperBT3, x=x, fill = "IC"), alpha = 0.2)+
      geom_line(data=dataBT, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BT3, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa total',colour='Loo')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('Sensibilidad a la Longitud asintótica (Loo)')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BD <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataBD,aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=BD3, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Biomasa desovante',colour='Loo')  +
       scale_colour_discrete(breaks=paste("y",seq(1,nretros,1),sep=""),
                            labels=seq(128, 136, 0.5)) +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
       scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5))


Ft <- ggplot() + 
      geom_ribbon(data=VarPob,aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
      geom_line(data=dataF, aes(y=value, x=year, colour = variable), size=0.5)+
      geom_line(data=VarPob,aes(y=Ft3, x=years), colour=1, size=0.5)+
      labs(x = '', y = 'Mortalidad por pesca',colour='Loo')  +
      scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
      scale_fill_manual("IC",values=c("grey45"))+
      theme_bw(base_size=8) +
      ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),legend.position="none")


BT/BD/Ft

```

\pagebreak

## 3.6. Variables de estado de erizo zona XI

```{r Fig_VarpoblXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Variables poblacionales de Erizo zona XI", fig.path=dir.Fig,fig.height=6, fig.width=8}


Rt <- ggplot(VarPob) + 
    geom_line(aes(y=Rt3, x=x, colour = "Estimado Zona XI"), size=0.5)+
    geom_ribbon(aes(ymin=lowerRt3, ymax=upperRt3, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BT <- ggplot(VarPob) + 
     geom_line(aes(y=BT3, x=x, colour = "Estimado Zona XI"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBT3, ymax=upperBT3, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa total',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD3, x=x, colour = "Estimado Zona XI"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft3, x=x, colour = "Estimado Zona XI"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT|BD/Ft


```

```{r Fig_SelFlotaXI,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="Modelo base. Selectividad de la flota de la Zona XI"}

age<-rep3$Edades
par(mfrow=c(1,1),mar=c(4,4,1,1))
	plot(age,rep3$Sel_f[1,],type="l",lwd=2,las=1,ylim=c(0,1.1),ylab="Selectividad",xlab="Edad (año)")
	lines(age,rep3$Sel_f[45,],type="o",pch="o")
	legend (6,0.5,c("sel_bloque (1960-2003)","sel_bloque (2004-2020)"),pch=c("","o"),lwd=c(2,1),bty='n',cex=0.8)

```

\pagebreak

## 3.7. Puntos Biológicos de Referencia de erizo zona XI

```{r  Fig_PBRsXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Puntos Biológicos de referencia de Erizo zona XI", fig.height=4.5, fig.width=4.5,eval=T}

Frms<-rep_pbr3$`F(%SSBo)`[2,]
BDo<-rep3$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2


BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD3, x=x, colour = "Estimado Zona XI"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "Intervalo de confianza asintótico"), alpha = 0.2)+
   geom_hline(yintercept = c(BDrms,BDlim,BDo),colour=c('green3','red','blue'))+
  annotate("text", x=c(rep(2012,3)), y=c(BDrms,BDlim,BDo),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]))) +
    labs(x = '', y = 'Biomasa desovante',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft3, x=x, colour = "Estimado Zona XI"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
   geom_line(aes(y=Frms, x=x), colour="green",size=0.5)+
     annotate("text", x=c(2011), y=c(Frms[nyears]),label=c(expression("F"[RMS]))) +
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD/Ft


```

\pagebreak

## 3.8. Estatus del erizo de la Región de Aysén

```{r Fig_DiagramaFaseXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Modelo base. Diagrama de fase propuesto para erizo zona XI",fig.height=4.5, fig.width=4.5,eval=T}

source(paste(dir.fun,"Fn_DiagramaFase.R",sep=""))

name0<-"Erizo Zona XI"
years0<-rep3$years
nyears0<-length(years0)

SSBt0         <- subset(std3,name=="BD")$value
SSBt0std      <- subset(std3,name=="BD")$std
Ft0           <- subset(std3,name=="log_F")$value
Ft0std        <- subset(std3,name=="log_F")$std
BDo0    <- rep3$BDo
BRMS0   <- BDo*0.4
FRMS0   <- rep_pbr3$`F(%SSBo)`[2,]

DiagramaFase(name0,FRMS0,BRMS0,SSBt0,SSBt0std,Ft0,Ft0std,years0,col_lastyear="blue",ylims=8,xlims=3)


```

\pagebreak

# 4. Análisis integrado de las tres zonas de estudio

```{r datInd2, warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig,eval=T}


cpueXN_obs  <- data.frame(rep1$CPUE_obs)
cpueXS_obs  <- data.frame(rep2$CPUE_obs)
cpueXI_obs  <- data.frame(rep3$CPUE_obs)


 obscpueXN  <- as.data.frame(cpueXN_obs) %>% 
   mutate(years=years) %>% 
   melt(id.vars='years') %>% 
   mutate(type='CPUE_XNorte')
 obscpueXS  <- as.data.frame(cpueXS_obs) %>% 
   mutate(years=years) %>% 
   melt(id.vars='years') %>% 
   mutate(type='CPUE_XSur')
 obscpueXI  <- as.data.frame(cpueXI_obs) %>% 
   mutate(years=years) %>% 
   melt(id.vars='years') %>%
   mutate(type='CPUE_XI')
 

Ind2  <-rbind(obscpueXN,obscpueXS,obscpueXI)


p2 <- ggplot()  +
  geom_line(data=Ind2, aes(x=years, y =value), stat="identity", fill='gray66', 
                   color = 'gray28') + 
  facet_wrap(type~.,scale="free",dir = 'v', as.table = TRUE) + 
  labs(x="Años", y="Nominal CPUE (kg/hora*Buzo)")+
  theme(panel.background = element_rect(fill ="gray99")) + 
  theme(panel.grid=element_line(color="gray66"))+
  scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 1))+
  theme(axis.text.x = element_text(angle = 90, hjust = 2))+
  theme_bw()+
  xlim(1996,2020)+
  ylim(50, 200)
p2

```


```{r echo=F}
# Desovante
totd <- BD1 + BD2 + BD3
biod <- cbind(years, BD1, BD2, BD3, totd)
biod <- as.data.frame(biod)
biod <-fortify(biod)

# Total
tot <- BT1 + BT2 + BT3
biot <- cbind(years, BT1, BT2, BT3, tot)
biot <- as.data.frame(biot)
biot <-fortify(biot)
```

```{r Plot_Biomasas, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="Biomasas Totales y Desovantes"}
# Grafico de Biomasas Desovantes


bd<- ggplot(biod) + 
     geom_line(aes(x=years, y=BD1, colour = 'X Norte'), size=0.5)+
     geom_line(aes(x=years, y=BD2, color = 'X Sur'), size=0.5)+
     geom_line(aes(x=years, y=BD3, color = 'XI'), size=0.5)+
    labs(x = '', y = 'Biomasas desovantes (t.)')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 2)) +
   scale_colour_manual("", 
                      breaks = c('X Norte','X Sur','XI'),
                      values = c("red", "green", "blue")) +
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),
           axis.text.x = element_text(angle=90))

# Grafico de Biomasas Totales

bt<- ggplot(biot) + 
     geom_line(aes(x=years, y=BT1, colour = 'X Norte'), size=0.5)+
     geom_line(aes(x=years, y=BT2, colour = 'X Sur'), size=0.5)+
     geom_line(aes(x=years, y=BT3, colour = 'XI'), size=0.5)+
    labs(x = '', y = 'Biomasas totales (t.)')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 2)) +
    scale_colour_manual("", 
                      breaks = c('X Norte','X Sur','XI'),
                      values = c("red", "green", "blue")) +
    theme_bw(base_size=12) +
     ggtitle('')+
      theme(plot.title = element_text(hjust = 0.5),
           axis.text.x = element_text(angle=90))

bd/bt 
```

A su vez, se presentan los valores estimados de cada variable de biomasas para cada zona a través de los años.

```{r}
biodm <- as.matrix(biod)
kable(biodm, format = "pipe",caption = "Biomasas Totales por zona", align = "c")
```

